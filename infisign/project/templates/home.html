{% extends 'navbase.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% block extra_css %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/editor.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <title>Document</title>
    {% endblock %}
</head>
<body>
    {% block content %}
    <div class="container-fluid mt-3">
        {% if messages %}
		<div class="messages">
		{% for message in messages %}
			<div class="alert {% if message.tags %}alert-{{ message.tags }}"{% endif %}>
				{{ message }}
			</div>
		{% endfor %}
		</div>
	{% endif %}
        <div class="row">
            <div class="col-lg-3 col-md-4 col-sm-12">
                <h3 class="heading">Categories</h3>
                <div style="position: relative; margin-bottom: 20px;">
                    <form method="post" id="searchForm">
                        {% csrf_token %}
                        <input type="text" id="searchInput" placeholder="Search" name="q" class="searchinput"
                            value="{{ query|default:'' }}" autocomplete="off">
                    </form>
                    <div id="searchResults" class="dropdown-menu w-100"
                        style="display: none; max-height: 300px; overflow-y: auto; position: absolute; z-index: 1000;">
                    </div>
                </div>
                <div class="list-group">
                    {% for category in categories %}
                    <a href="?category_id={{ category.id }}"
                        class="list-group-item list-group-item-action {% if selected_category and category.id == selected_category.id %}active{% endif %}">
                        {{ category.name }}
                        {% if selected_category and category.id == selected_category.id %}
                        <span><i class="icon-arrow"></i> ></i></span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
            <div class="col-lg-9 col-md-8 col-sm-12">
                {% if not categories %}
                <div class="center-btn">
                    <a href="{% url 'create_blog_post' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Create
                    </a>
                </div>
                {% else %}
                <div class="create-btn">
                    <a href="{% url 'create_blog_post' %}" class="button">
                        <i class="bi bi-plus-lg"></i> Create
                    </a>
                </div>
                {% endif %}
                <div class="content">
                    {% if selected_category and not selected_article %}
                    <h3 class="heading">{{ selected_category.name }}</h3>
                    <ul>
                        {% if selected_category.blogposts.all %}
                        {% for article in selected_category.blogposts.all %}
                        <li>
                            <a href="?category_id={{ selected_category.id }}&article_id={{ article.id }}"
                                class="article-li">
                                <i class="bi bi-file-earmark-text"></i> {{ article.title }}
                            </a>

                            <a href="{% url 'edit_article' article.id %}" class="text-warning mr-2" title="Edit">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <a href="#" class="text-danger" title="Delete" data-toggle="modal"
                                data-target="#deleteModal" data-article-id="{{ article.id }}"
                                data-article-title="{{ article.title }}">
                                <i class="bi bi-trash"></i>
                            </a>
                        </li>
                        {% endfor %}
                        {% else %}
                        <li class="noarticle">No articles in this category.</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                {% if selected_article %}
                <div class="mt-4">
                    <h3 class="contentheading">{{ selected_article.title }}</h3>
                    <p>{{ selected_article.content|safe }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- model -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete Blog Post</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this post: <strong id="articleTitle"></strong>?
                </div>
                <div class="modal-footer">
                    <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Delete</a>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#deleteModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var articleTitle = button.data('article-title');
                var articleId = button.data('article-id');

                var modal = $(this);
                modal.find('#articleTitle').text(articleTitle);
                modal.find('#confirmDeleteBtn').attr('href', `/delete/${articleId}/`);
            });
        });

        $(document).ready(function () {
            let typingTimer;
            const typingDelay = 300;
            $('#searchInput').on('input', function () {
                clearTimeout(typingTimer);
                const query = $(this).val().trim();
                if (query.length > 0) {
                    typingTimer = setTimeout(() => {
                        $.ajax({
                            url: window.location.pathname,
                            type: 'POST',
                            data: {
                                q: query,
                                csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                            },
                            success: function (response) {
                                const resultsContainer = $('#searchResults');
                                resultsContainer.empty();
                                if (response.results && response.results.length > 0) {
                                    response.results.forEach((article) => {
                                        resultsContainer.append(`
                                    <div class="search-result">
                                        <a href="?article_id=${article.id}" class="dropdown-item">
                                            ${article.title}
                                        </a>
                                    </div>
                                `);
                                    });
                                    resultsContainer.show();
                                } else {
                                    resultsContainer.html(
                                        '<div class="dropdown-item text-warning">No articles found.</div>'
                                    );
                                    resultsContainer.show();
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error('Error fetching search results:', error);
                            },
                        });
                    }, typingDelay);
                } else {
                    $('#searchResults').hide();
                }
            });

            $(document).on('click', function (e) {
                if (!$(e.target).closest('#searchResults, #searchInput').length) {
                    $('#searchResults').hide();
                }
            });
        });
    </script>
    {% endblock %}
</body>
</html>